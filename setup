#!/bin/bash

set -e

# Check for -prod flag
ENVIRONMENT="development"
if [[ "$1" == "-prod" ]]; then
  ENVIRONMENT="production"
fi

echo "=== AlgoLounge Setup ==="
echo "Environment: $ENVIRONMENT"
echo ""

# Git pull
echo "Pulling latest changes..."
git pull

echo ""
echo "Installing frontend dependencies..."
cd frontend
npm install
cd ..

echo ""
echo "Installing backend dependencies..."
cd backend
npm install
cd ..

echo ""
echo "Setting up database..."
cd backend
rm -f *.db *.db-shm *.db-wal
npm run db:generate
npm run db:push
cd ..

echo ""
echo "Setting up environment configuration..."

# Create frontend environment file
mkdir -p frontend/src/environments
if [[ "$ENVIRONMENT" == "production" ]]; then
  cat > frontend/src/environments/environment.ts << 'EOF'
export const environment = {
  production: true,
  apiUrl: ''
};
EOF
  echo "NODE_ENV=production" > backend/.env.local
else
  cat > frontend/src/environments/environment.ts << 'EOF'
export const environment = {
  production: false,
  apiUrl: 'http://localhost:3000'
};
EOF
  echo "NODE_ENV=development" > backend/.env.local
fi

echo ""
echo "=== Setup Complete ==="
echo "Environment: $ENVIRONMENT"
echo "Run './start' to start development servers"
